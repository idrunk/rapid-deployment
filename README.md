# 快捷部署工具

这是一个快捷部署工具，可以方便的部署linux应用，也可以在windows上利用git-bash部署平台无关的docker应用。

快捷部署工具功能特性：

- 全bash实现，兼容性好、较灵活
- 支持本地、远程部署
- 支持二进制、docker等部署方式
- 预备与安装分离，方便离线部署
- 定义了标准接口，方便接入自定义部署脚本
- 支持记录交互日志（基于tee）

*本工具由`bash`编写，可在大部分linux上直接执行。windows上可通过git-bash执行，若未安装git请先安装，然后可通过工具根目录下的`bash.bat`自动打开`bash`终端，也可以手动打开git-bash终端运行本工具。*


## 安装包预备

当前内置的大部分安装脚本都支持离线部署，离线部署需要预备安装包，以便部署时直接用预备好的包部署，而不是现场下载。

1. bash终端进入到快捷部署根目录，执行`./adm`
2. 输入`1`，进入可预备包列表
3. 输入你需要预备的包编号，可同时输入多个，以半角空格分开，也可输入`*`全选，最后按回车进入下一步
4. 确认你的选择，`y`确认，`n`取消


## 远程部署预备

如果需要远程部署，则需要先开启共享，本工具内置了三种共享开启方法：

### Windows原生共享

#### 安装windows版sudo

由于windows共享命令需要以超级管理员角色执行，所以需要先安装`sudo`，通过sudo以超管执行。sudo是一个rust编写的工具，会内置于win11 24h2，但将其复制到win10等系统下也能使用。本工具内置了一个编译好的`sudo.exe`于`.libs/.packages/sudo.exe`目录下，你可以按下述步骤安装：

1. 复制`.libs/.packages/sudo.exe`到`C:\Windows\System32\sudo.exe`
2. "以管理员身份运行"打开windows终端或cmd
3. 执行`sudo config --enable enable`开启sudo命令支持

#### 开启Windows原生共享

1. 终端进入到快捷部署根目录，执行`sudo ./adm`
2. 输入`6`，进入共享方式列表
3. 输入`1`，选择Windows原生共享
4. 选择`1`开启共享，`2`取消共享等
5. 选择`3`将显示挂载命令，如`mount -t cifs //2408:1:1:1::1234/rapid-deployment ./MOUNTPOINT -o port=9960,username=USER,password=PASSWORD`
6. 复制上述步骤生成的挂载命令，到远程终端粘贴（若`MOUNTPOINT`等不对则需修正），回车执行挂载

- *若在远程终端挂载不成功，可确认是否被windows防火墙阻挡，可关闭防火墙再试*
- *挂载可通过ip4或ip6，如果与远程主机在同个局域网下，可通过ip4挂载，否则可选ip6挂载（ip6一般为公网ip）*

- *显示挂载命令时会列出主机ip，如果默认挂载命令所选的ip不对，可自行改为其他的尝试*
- *`port=9960`是因为在执行`share`时会建立一个9960到445的端口映射，以解决普通宽带禁止445端口的问题，内网挂载可移除该配置以使用默认的445端口*

### Docker版samba/nfs共享

Linux主机可通过docker版命令共享本工具，步骤如下：

1. 终端进入到快捷部署根目录，执行`./adm`
2. 输入`6`，进入共享方式列表
3. 输入`2`或`3`，开启smb或nfs共享；`4`或`5`关闭共享
4. 输入`6`可显示挂载命令


## 执行安装

本工具支持远程安装与本地安装。远程安装通过上述的[远程部署预备](#远程部署预备)共享本工具，然后挂载到远程终端执行安装，也可以通过U盘等直接挂载到目标主机上执行安装。

### 安装

1. 终端进入到快捷部署工具根目录，执行`./app`
2. 确定`INSTL_ROOT`等基础环境变量是否正确，不正确则输入`e`编辑
3. 输入`1`进入安装软件列表
4. 输入你要安装的软件编号，可同时输入多个，以半角空格分开，也可输入`*`全选，最后按回车进入下一步
5. 输入`y`确认你的选择，`n`取消
6. 等待安装步骤完成

### 卸载

在执行`./app`后输入`2`进入卸载交互，卸载仅会移除软件程序，不会清除数据。若要清除数据，需回到主界面输入`3`清除数据，若需要可再回到主界面输入`4`清除docker镜像。

### 系统工具集

在`./app`主界面输入`6`进入系统工具集，系统工具集包括一些应用的维护工具，及linux系统初始化相关工具（如设置软件源等）。


## 接入自定义软件部署脚本

1. 在工具根目录下创建软件脚本目录
2. 若需离线部署，则在该目录下创建`pack.sh`（可参考其他`pack.sh`的实现）
3. 若为docker版脚本，则在该目录下创建`docker-install.sh`，否则创建`pkg-install.sh`（可参考其他实现）
4. 若需要编写维护工具，则在该目录下创建`tool.sh`（可参考其他实现）


## 后续规划

后续大概还会实现一个ddns工具及kvm安装脚本，再然后就没有更多计划了，大家有什么需求可自行扩展实现，然后请求合并到这里。


## 已支持软件信息表

|     软件      |    典型端口     |       端口        |
| :-----------: | :-------------: | :---------------: |
|    Cockpit    |                 |       0000        |
|      SSH      |                 |       0002        |
|    Grafana    |                 |       0004        |
|  Promethues   |                 |       0005        |
|   Postgres    |                 |       0015        |
|     Mysql     |                 |       0016        |
|    Adminer    |                 |       0017        |
|     pgweb     |                 |       0018        |
|      Frp      |                 | 0020,0021,0030-49 |
|      N2N      |                 |       0022,       |
|   Headscale   | 8080,9090,50443 |  0023,0024,0025   |
| Homeassistant |                 |       0050        |
|     Samba     |     445,139     |     0060,0061     |
|   Cloudreve   |                 |       0062        |
|      NFS      |    2049,111     |     0064,0065     |
|    Seafile    |                 |       0070        |
|   Nextcloud   |                 |       0072        |
|  Onlyoffice   |                 |       0080        |
|     Gitea     |                 |     0090,0091     |
|    Gitlab     |                 |     0092,0093     |
|   Svnadmin    |                 |     0094,0095     |
|   Perforce    |                 |       0096        |